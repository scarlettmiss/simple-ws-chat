<!doctype html>
<html lang="en">
<head>
    <title>Socket.IO chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 13px Helvetica, Arial; }
        form { flex: 1; background: #000; padding: 3px; width: 100%; padding-top: 16px}
        form input { padding: 10px; width: 90%; margin-right: .5%; border: 1px black solid }
        form button { background: rgb(130, 224, 255); border: none; padding: 10px; }
        #messages { list-style-type: none; margin: 0; padding: 0; }
        #messages li { padding: 5px 10px; }
        #messages li:nth-child(odd) { background: #eee; }
    </style>
</head>
<body>
<ul id="messages"></ul>

<div id="userActions">
    <div>
        <label for="username" style="color: white">username</label>
        <input id="username" autocomplete="off" />
    </div>
    <div>
        <label for="password" style="color: white">password</label>
        <input type="password" id="password" autocomplete="off" />
    </div>
    <button onclick="createUser()">create User</button>
    <button onclick="logUser()">logIn</button>
</div>

<div id="roomActions" style="display: none">
    <div id="roomCreation" >
    <div>
        <label for="skill" style="color: white">skill</label>
        <input id="skill" type="range" min="1000" max="2000" step="100" value="50">
    </div>
    <div>
        <label for="capacity" style="color: white">capacity</label>
        <input id="capacity" type="range" min="2" max="8" step="1" value="4">
    </div>

    <div>
        <label for="visibility" style="color: white">visibility</label>
        <select id="visibility" name="Constraints">
            <option value="none" selected>Public</option>
            <option value="friendsOnly">Friends</option>
            <option value="invitationOnly">Invitation</option>
        </select>
    </div>

    <button onclick="createRoom()">create Room</button>
    <button onclick="onRoomSearchPress()">Rooms</button>
    <button onclick="requestMatchMaking()">Find Room</button>
    </div>
    <div id="roomJoin">
        <div>
            <label for="roomId" style="color: white">Room Id</label>
            <input id="roomId">
        </div>

        <button onclick="joinRoom()">Join room</button>
    </div>
</div>


<div id="messageActions" style="display: none">
    <label for="message" style="color: white">Message</label>
    <input id="message"/>
    <button onclick="sendChatMessage()">Send</button>
    <button onclick="leaveRoom()">Leave Room</button>

</div>

<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
    var socket = io("");

    function disconnect() {
        socket.emit('bye');
    }

    socket.on('chatMessage', function(msg) {
        console.log(msg)
        const message = JSON.parse(msg)
        if (message) {
            $('#messages').append($('<li>').text(`${message.username} said: ${message.message}`));
        }
    });

    socket.on('userJoinedRoom', function(msg) {
        console.log(msg)
        const message = JSON.parse(msg)
        if (message) {
            $('#messages').append($('<li>').text(`user ${message.username} joined`));
        }
    });

    socket.on('userLeftRoom', function(msg) {
        console.log(msg)
        const message = JSON.parse(msg)
        if (message) {
            $('#messages').append($('<li>').text(`user ${message.username} left`));
        }
    });
    var user
    var room
    var rooms

    var interval

    function  setRoomInterval() {
        if(!interval) {
            interval = setInterval(getRooms, 3000)
        }
    }

    function clearRoomInterval() {
        clearInterval(interval)
    }

    function onRoomSearchPress() {
        setRoomInterval()
        $('#roomJoin').show()
        $("#roomCreation").hide()
    }

    function setElementsAfterUser() {
        if(user) {
            $('#userActions').hide()
            $('#roomActions').show()
            $('#roomCreation').show()
            $('#roomJoin').hide()
            $('#messageActions').hide()
        } else {
            $('#userActions').show()
            $('#roomActions').hide()
            $('#messageActions').hide()
        }
    }

    function setElementsAfterRoom() {
        if(room) {
            $('#userActions').hide()
            $('#roomActions').hide()
            $('#roomCreation').show()
            $('#roomJoin').hide()
            $('#messageActions').show()
        } else {
            $('#userActions').hide()
            $('#roomActions').show()
            $('#roomCreation').show()
            $('#roomJoin').hide()
            $('#messageActions').hide()
        }
    }

    function createUser() {
        console.log("clicked")
        const username = $('#username').val();
        const password = $('#password').val();
        socket.emit('createUser', JSON.stringify({"username": username, "password" : password}), function(data) {
            const parced = JSON.parse(data)
            if (parced && !parced.error) {
                user = parced
                $('#messages').append($('<li>').text('userCreated: ' + data));
            } else {
                console.error(data)
            }
            setElementsAfterUser()
        });
    }

    function logUser() {
        console.log("clicked 2")
        const username = $('#username').val();
        const password = $('#password').val();
        const m =  {"username": username, "password" : password}
        socket.emit('userAuthentication', JSON.stringify(m), function(data) {
            const parced = JSON.parse(data)
            if (parced && !parced.error) {
                user = parced
                $('#messages').append($('<li>').text('user Logged in: ' + data));
            } else {
                console.error(data)
            }
            setElementsAfterUser()
        });
    }

    function requestMatchMaking() {
        console.log("clicked requestMatchMaking")
        const m = {"user_id": user.id}
        socket.emit('userRequestMatchMaking', JSON.stringify(m), function(data) {
            const parced = JSON.parse(data)
            if (parced && !parced.error) {
                room = parced
                $('#messages').append($('<li>').text('room Joined: ' + data));
            } else {
                console.error(data)
                $('#messages').append($('<li>').text('Err:  ' + data));
            }
            console.log(data)
            setElementsAfterRoom()
        });
    }

    function createRoom() {
        console.log("create room")
        const skill = $('#skill').val();
        const capacity = $('#capacity').val();
        const visibility = $('#visibility').val();
        const m = {"user_id": user.id,
            "capacity": Number(capacity),
            "rating": Number(skill),
            "constraint": visibility}
        socket.emit('createRoom', JSON.stringify(m), function(data) {
            const parced = JSON.parse(data)
            if (parced && !parced.error) {
                room = parced
                $('#messages').append($('<li>').text('room created: ' + data));
            } else {
                console.error(data)
            }
            setElementsAfterRoom()
        });
    }

    function leaveRoom() {
        console.log("Leave room")
        const m = {"user_id": user.id,
            "session_id": room.id}
        socket.emit('userLeaveRoom', JSON.stringify(m), function(data) {
            const parced = JSON.parse(data)
            if (parced && !parced.error) {
                room = undefined
                $('#messages').append($('<li>').text('room Left: ' + data));
            } else {
                console.error(data)
            }
            setElementsAfterRoom()
        });
    }

    function joinRoom() {
        console.log("Join room")
        const roomId = $('#roomId').val();
        const m = {"user_id": user.id,
            "session_id": roomId}
        socket.emit('userJoinRoom', JSON.stringify(m), function(data) {
            const parced = JSON.parse(data)
            if (parced && !parced.error) {
                room = parced
                $('#messages').append($('<li>').text('room Joined: ' + data));
            } else {
                console.error(data)
            }
            setElementsAfterRoom()
            clearRoomInterval()
        });
    }

    function getRooms() {
        console.log("getRooms")
        socket.emit('getRooms', function(data) {
            console.log(data)
            const parced = JSON.parse(data)
            if (parced && !parced.error) {
                rooms = parced
                $('#messages').append($('<li>').text('rooms: ' + data));
            } else {
                console.error(data)
            }
        });
    }

    function sendChatMessage() {
        console.log("send to room")
        const mess = $('#message').val();
        const m = {"user_id": user.id,
            "session_id": room.id,
            "message": mess
        }
        socket.emit('userMessage', JSON.stringify(m), function(data) {
            const parced = JSON.parse(data)
            if (parced&& !parced.error) {
                $('#messages').append($('<li>').text(data));
            } else {
                console.error(data)
            }
        });
    }
</script>
</body>
</html>
